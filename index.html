<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Class Assistant</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #4285f4; --bg: #f0f2f5; --text: #333; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); -webkit-font-smoothing: antialiased; }
        
        /* ë ˆì´ì•„ì›ƒ */
        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center; }
        .logo-area { margin-bottom: 40px; }
        .logo-icon { font-size: 3em; color: var(--primary); margin-bottom: 10px; }
        
        /* ë©”ì¸ í™”ë©´ */
        #app-screen { display: none; padding: 20px; padding-bottom: 80px; }
        
        /* ìƒë‹¨ í—¤ë” */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .welcome-badge { background: #e8f0fe; color: var(--primary); padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; }

        /* íƒ­ ë²„íŠ¼ (ìƒë‹¨ ê³ ì • ìŠ¤íƒ€ì¼) */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #f8f9fa; padding: 5px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; border-radius: 8px; font-weight: 600; color: #666; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* ì»¨í…ì¸  ì˜ì—­ */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ì…ë ¥ í¼ ê³µí†µ */
        input, select, textarea { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; box-sizing: border-box; outline: none; transition: 0.2s; }
        input:focus, textarea:focus { border-color: var(--primary); }
        textarea { resize: none; min-height: 120px; line-height: 1.5; }

        /* ë©”ì¸ ì•¡ì…˜ ë²„íŠ¼ */
        button.action-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 10px rgba(66,133,244,0.3); }
        button.action-btn:active { transform: scale(0.98); }

        /* --- [ëª¨ë°”ì¼ ìµœì í™” í•™ìƒ ì¹´ë“œ] --- */
        .profile-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #eee; margin-top: 10px; }
        
        .profile-header { background: linear-gradient(135deg, #4285f4, #3367d6); color: white; padding: 25px 20px; text-align: center; }
        .profile-name { font-size: 1.8em; font-weight: 800; margin: 0; }
        .profile-birth { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 15px; font-size: 0.9em; margin-top: 8px; display: inline-block; }
        
        .profile-body { padding: 10px 0; }
        .info-row { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f4f6f8; }
        .info-row:last-child { border-bottom: none; }
        
        .info-icon { width: 36px; height: 36px; background: #f0f5ff; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; }
        .info-content { flex: 1; display: flex; flex-direction: column; }
        .info-label { font-size: 0.8em; color: #888; margin-bottom: 3px; }
        .info-value { font-size: 1.05em; color: #333; font-weight: 500; }
        
        /* ì „í™” ê±¸ê¸° ë²„íŠ¼ */
        .call-btn { text-decoration: none; background: #e8f5e9; color: #2e7d32; padding: 6px 12px; border-radius: 8px; font-size: 0.85em; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        
        /* íŠ¹ì´ì‚¬í•­ ë°•ìŠ¤ */
        .memo-box { background: #fff8f8; border-left: 4px solid #ff5252; padding: 15px; margin: 15px 20px 25px; border-radius: 4px; }
        .memo-label { color: #d32f2f; font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px; }
        .memo-text { font-size: 0.95em; line-height: 1.5; color: #333; }

        /* íˆ´ë°” (ìŒì„±/íŒŒì¼) */
        .toolbar { display: flex; gap: 8px; margin-bottom: 8px; }
        .tool-icon { background: #fff; border: 1px solid #ddd; padding: 8px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; color: #555; }
        .tool-icon.recording { background: #ffebee; color: #d32f2f; border-color: #d32f2f; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* AI ê²°ê³¼ ë°•ìŠ¤ */
        .ai-result { background: #f8faff; padding: 20px; border-radius: 12px; margin-top: 15px; line-height: 1.6; border: 1px solid #e1e9f5; font-size: 0.95em; white-space: pre-wrap; display: none; }
    </style>
</head>
<body>

    <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen">
        <div class="logo-area">
            <div class="logo-icon"><i class="fas fa-chalkboard-teacher"></i></div>
            <h2>êµì‚¬ ì—…ë¬´ ì§€ì› ì‹œìŠ¤í…œ</h2>
            <p style="color:#666;">í™˜ì˜í•©ë‹ˆë‹¤, ì„ ìƒë‹˜.</p>
        </div>
        <!-- [ìˆ˜ì •í•„ìš” 1] Client ID ì…ë ¥ -->
        <div id="g_id_onload"
             data-client_id="1075901830630-jss5b3872vlu0p34t5i8j97gu3puonju.apps.googleusercontent.com" 
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-width="250"></div>
    </div>

    <!-- 2. ë©”ì¸ ì•± í™”ë©´ -->
    <div id="app-screen" class="app-container">
        <header>
            <h3 style="margin:0;">Class Assistant</h3>
            <span id="user-name" class="welcome-badge"></span>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab-search')">í•™ìƒì¡°íšŒ</button>
            <button class="tab-btn" onclick="switchTab('tab-log')">ê¸°ë¡</button>
            <button class="tab-btn" onclick="switchTab('tab-ai')">AIë³´ì¡°</button>
        </div>

        <!-- [íƒ­ 1] í•™ìƒ ì¡°íšŒ -->
        <div id="tab-search" class="section active">
            <div style="display: flex; gap: 8px;">
                <input type="text" id="search-input" placeholder="ì´ë¦„ ì…ë ¥ (ì˜ˆ: ì² ìˆ˜)" onkeydown="if(event.key==='Enter') searchStudent()">
                <button class="action-btn" style="width: 80px; margin-bottom:12px;" onclick="searchStudent()"><i class="fas fa-search"></i></button>
            </div>
            <div id="search-result"></div>
        </div>

        <!-- [íƒ­ 2] ê¸°ë¡ -->
        <div id="tab-log" class="section">
            <input type="text" id="log-name" placeholder="í•™ìƒ ì´ë¦„">
            <select id="log-category">
                <option value="ìˆ˜ì—…">ìˆ˜ì—… (êµê³¼)</option>
                <option value="ìƒí™œ">ìƒí™œì§€ë„/í–‰ë™</option>
                <option value="ìƒë‹´">ìƒë‹´ (í•™ìƒ/í•™ë¶€ëª¨)</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
            
            <div class="toolbar">
                <button class="tool-icon" id="mic-btn" onclick="toggleSpeech()"><i class="fas fa-microphone"></i> ìŒì„±</button>
                <label class="tool-icon"><i class="fas fa-file-alt"></i> íŒŒì¼ <input type="file" accept=".txt" style="display:none" onchange="loadFile(this)"></label>
            </div>

            <textarea id="log-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            <button class="action-btn" onclick="saveLog()">ì €ì¥í•˜ê¸°</button>
        </div>

        <!-- [íƒ­ 3] AI ë³´ì¡° ë° ìë™ ìƒì„± -->
        <div id="tab-ai" class="section">
            <div style="background:#e8f0fe; padding:15px; border-radius:12px; margin-bottom:15px;">
                <h4 style="margin:0 0 5px 0; color:var(--primary);">ğŸ¤– Gemini ì„ ìƒë‹˜</h4>
                <p style="margin:0; font-size:0.85em; color:#555;">ê°œë³„ ì§ˆë¬¸ ë˜ëŠ” ìƒí™œê¸°ë¡ë¶€ ì¼ê´„ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>
            </div>

            <!-- 1. ê°œë³„ ì§ˆë¬¸ ëª¨ë“œ -->
            <div class="card" style="border:1px solid #ddd; box-shadow:none; padding:15px; margin-bottom:20px;">
                <h5 style="margin:0 0 10px 0;"><i class="fas fa-comment-dots"></i> ê°œë³„ ìƒë‹´</h5>
                <input type="text" id="ai-name" placeholder="í•™ìƒ ì´ë¦„">
                <textarea id="ai-query" placeholder="ì§ˆë¬¸ (ì˜ˆ: ì´ í•™ìƒì˜ íŠ¹ì„± ìš”ì•½í•´ì¤˜)" style="min-height:80px;"></textarea>
                <button class="action-btn" onclick="askAI()">ì§ˆë¬¸í•˜ê¸°</button>
                <div id="ai-result" class="ai-result"></div>
            </div>

            <!-- 2. ì¼ê´„ ìƒì„± ëª¨ë“œ (ì‹ ê·œ ê¸°ëŠ¥) -->
            <div class="card" style="border:2px solid var(--primary); box-shadow:none; padding:15px; background:#fff;">
                <h5 style="margin:0 0 10px 0; color:var(--primary);"><i class="fas fa-magic"></i> ìƒê¸°ë¶€ ìë£Œ ì¼ê´„ ìƒì„±</h5>
                <p style="font-size:0.8em; color:#666; margin-bottom:10px;">
                    'Guidelines' ì‹œíŠ¸ì˜ ì§€ì¹¨ì„ ë°˜ì˜í•˜ì—¬<br>
                    <strong>'Drafts' ì‹œíŠ¸ì— ê²°ê³¼ë¥¼ ì €ì¥</strong>í•©ë‹ˆë‹¤.
                </p>

                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="action-btn" style="background:#2e7d32;" onclick="startBatch('í–‰ë™íŠ¹ì„±')">
                        <i class="fas fa-user-graduate"></i> í–‰íŠ¹ ìƒì„±
                    </button>
                    <button class="action-btn" style="background:#f57c00;" onclick="askSubjectAndStart()">
                        <i class="fas fa-book-open"></i> êµê³¼ ìƒì„±
                    </button>
                </div>
                
                <!-- ì§„í–‰ ìƒíƒœ í‘œì‹œì¤„ -->
                <div id="batch-status" style="display:none; margin-top:10px; padding:10px; background:#f5f5f5; border-radius:8px; font-size:0.9em;">
                    <div id="progress-text" style="font-weight:bold; margin-bottom:5px;">ëŒ€ê¸° ì¤‘...</div>
                    <div style="width:100%; background:#ddd; height:10px; border-radius:5px;">
                        <div id="progress-bar" style="width:0%; height:100%; background:var(--primary); border-radius:5px; transition: width 0.3s;"></div>
                    </div>
                    <div id="current-log" style="font-size:0.8em; color:#666; margin-top:5px; height:20px; overflow:hidden;"></div>
                </div>
            </div>
        </div>

    <!-- (ìŠ¤í¬ë¦½íŠ¸ ë¶€ë¶„ì— ì•„ë˜ í•¨ìˆ˜ë“¤ ì¶”ê°€) -->
    <script>
        // ... (ê¸°ì¡´ ë³€ìˆ˜ ë° í•¨ìˆ˜ë“¤ ìœ ì§€) ...

        // [ì‹ ê·œ] êµê³¼ëª© ì´ë¦„ ë¬»ê¸°
        function askSubjectAndStart() {
            const subject = prompt("ì–´ë–¤ ê³¼ëª©ì˜ ì„¸íŠ¹ì„ ìƒì„±í• ê¹Œìš”?\n(ì˜ˆ: êµ­ì–´, ìˆ˜í•™, ì‚¬íšŒ)");
            if (subject) {
                startBatch('êµê³¼ì„¸íŠ¹', subject);
            }
        }

        // [ì‹ ê·œ] ì¼ê´„ ì‘ì—… ì‹œì‘ (í•µì‹¬ ë¡œì§)
        async function startBatch(type, subject = "") {
            if (!confirm(`ì „ì²´ í•™ìƒì˜ [${type}${subject ? "-" + subject : ""}] ìë£Œë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‹œê°„ì´ ë‹¤ì†Œ ì†Œìš”ë©ë‹ˆë‹¤.`)) return;

            const statusBox = document.getElementById("batch-status");
            const pText = document.getElementById("progress-text");
            const pBar = document.getElementById("progress-bar");
            const pLog = document.getElementById("current-log");

            statusBox.style.display = "block";
            pText.innerText = "í•™ìƒ ëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            
            // 1. ì „ì²´ í•™ìƒ ëª…ë‹¨ ê°€ì ¸ì˜¤ê¸°
            const names = await callAPI("getAllStudentNames", {});
            
            if (!names || names.length === 0) {
                alert("í•™ìƒ ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.");
                statusBox.style.display = "none";
                return;
            }

            // 2. í•œ ëª…ì”© ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ (for loop)
            let successCount = 0;
            for (let i = 0; i < names.length; i++) {
                const name = names[i];
                const percent = Math.round(((i + 1) / names.length) * 100);
                
                // UI ì—…ë°ì´íŠ¸
                pText.innerText = `ì§„í–‰ ì¤‘: ${i + 1} / ${names.length} ëª… (${percent}%)`;
                pBar.style.width = `${percent}%`;
                pLog.innerText = `â–¶ ${name} í•™ìƒ ë°ì´í„° ë¶„ì„ ë° ìƒì„± ì¤‘...`;

                try {
                    // AI ìƒì„± ìš”ì²­
                    await callAPI("generateDraft", { 
                        studentName: name, 
                        type: type, 
                        subject: subject 
                    });
                    successCount++;
                } catch (e) {
                    pLog.innerText = `âš ï¸ ${name} ìƒì„± ì‹¤íŒ¨: ${e.message}`;
                    console.error(e);
                    // ì‹¤íŒ¨í•´ë„ ë©ˆì¶”ì§€ ì•Šê³  ë‹¤ìŒ í•™ìƒìœ¼ë¡œ ë„˜ì–´ê°
                }
            }

            pText.innerText = "ì™„ë£Œ!";
            pLog.innerText = `ì´ ${successCount}ëª…ì˜ ìë£Œê°€ 'Drafts' ì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            alert(`ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nêµ¬ê¸€ ì‹œíŠ¸ì˜ 'Drafts' íƒ­ì„ í™•ì¸í•˜ì„¸ìš”.`);
        }
    </script>
        // ==========================================
        // [ìˆ˜ì •í•„ìš” 2] GAS ë°°í¬ ì£¼ì†Œ ì…ë ¥
        // ==========================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwhPeaw3O2qAPkPEfGUGEc9_Kaqz_T5xULRb3jgzmPq7BNiAtKLl8dnIpoobxHz9wwzUg/exec"; 
        
        let USER_TOKEN = "";

        function handleCredentialResponse(response) {
            USER_TOKEN = response.credential;
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("app-screen").style.display = "block";
            document.getElementById("user-name").innerText = `ğŸ‘‹ ${payload.name} ì„ ìƒë‹˜`;
        }

        function switchTab(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        async function callAPI(action, payload) {
            try {
                const res = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ token: USER_TOKEN, action, ...payload })
                });
                const json = await res.json();
                if (json.status === "error") throw new Error(json.message);
                return json.data;
            } catch (e) {
                alert("ì˜¤ë¥˜: " + e.message);
                return null;
            }
        }

        // [ê¸°ëŠ¥ 1] í•™ìƒ ì¡°íšŒ (ëª¨ë°”ì¼ ì¹´ë“œ UI)
        async function searchStudent() {
            const nameInput = document.getElementById("search-input");
            const name = nameInput.value.trim();
            if(!name) return;
            nameInput.blur(); // í‚¤íŒ¨ë“œ ë‚´ë¦¬ê¸°

            const box = document.getElementById("search-result");
            box.innerHTML = `<div style="text-align:center; padding:30px;"><i class="fas fa-spinner fa-spin"></i> ì¡°íšŒ ì¤‘...</div>`;
            
            const data = await callAPI("getStudentInfo", { studentName: name });
            
            if (data) {
                box.innerHTML = `
                    <div class="profile-card">
                        <div class="profile-header">
                            <h3 class="profile-name">${data.name}</h3>
                            <span class="profile-birth">ğŸ‚ ${data.birth}</span>
                        </div>
                        <div class="profile-body">
                            <div class="info-row">
                                <div class="info-icon"><i class="fas fa-user-check"></i></div>
                                <div class="info-content"><span class="info-label">(ì£¼)ë³´í˜¸ì</span><span class="info-value">${data.parentMain}</span></div>
                                <a href="tel:${data.parentMain}" class="call-btn"><i class="fas fa-phone"></i> í†µí™”</a>
                            </div>
                            <div class="info-row">
                                <div class="info-icon"><i class="fas fa-user-friends"></i></div>
                                <div class="info-content"><span class="info-label">(ë¶€)ë³´í˜¸ì</span><span class="info-value">${data.parentSub || "-"}</span></div>
                            </div>
                            <div class="info-row">
                                <div class="info-icon"><i class="fas fa-school"></i></div>
                                <div class="info-content"><span class="info-label">ë°©ê³¼í›„ / ë‘ë ˆ</span><span class="info-value">${data.afterSchool || "-"} | ${data.dure || "-"}</span></div>
                            </div>
                            <div class="info-row">
                                <div class="info-icon"><i class="fas fa-map-marker-alt"></i></div>
                                <div class="info-content"><span class="info-label">ì£¼ì†Œ</span><span class="info-value" style="font-size:0.9em;">${data.address}</span></div>
                            </div>
                        </div>
                        <div class="memo-box">
                            <span class="memo-label"><i class="fas fa-exclamation-triangle"></i> íŠ¹ì´ì‚¬í•­</span>
                            <span class="memo-text">${data.memo || "ì—†ìŒ"}</span>
                        </div>
                    </div>
                `;
            } else {
                box.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
        }

        // [ê¸°ëŠ¥ 2] ê¸°ë¡ ì €ì¥ (addLog í˜¸ì¶œ)
        async function saveLog() {
            const name = document.getElementById("log-name").value.trim();
            const content = document.getElementById("log-content").value.trim();
            if(!name || !content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            if(confirm("ê¸°ë¡ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const res = await callAPI("addLog", { 
                    payload: {
                        studentName: name,
                        category: document.getElementById("log-category").value,
                        content: content
                    } 
                });
                if(res) {
                    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    document.getElementById("log-content").value = "";
                }
            }
        }

        // [ê¸°ëŠ¥ 3] AI ì§ˆë¬¸
        async function askAI() {
            const name = document.getElementById("ai-name").value.trim();
            const query = document.getElementById("ai-query").value.trim();
            if(!query) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const box = document.getElementById("ai-result");
            box.style.display = "block";
            box.innerText = "ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... â³";
            
            const data = await callAPI("askAI", { studentName: name, query: query });
            if (data) box.innerText = data.answer;
        }

        // ìœ í‹¸ë¦¬í‹° (ìŒì„±/íŒŒì¼)
        let recognition = null;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.onstart = () => { document.getElementById("mic-btn").classList.add("recording"); };
            recognition.onend = () => { document.getElementById("mic-btn").classList.remove("recording"); };
            recognition.onresult = (e) => { document.getElementById("log-content").value += " " + e.results[0][0].transcript; };
        }
        function toggleSpeech() { recognition ? (document.getElementById("mic-btn").classList.contains("recording") ? recognition.stop() : recognition.start()) : alert("í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”."); }
        function loadFile(input) {
            const reader = new FileReader();
            reader.onload = (e) => { document.getElementById("log-content").value += `\n[ì²¨ë¶€] ${e.target.result}`; alert("íŒŒì¼ ë¡œë“œë¨"); };
            input.files[0] && reader.readAsText(input.files[0]);
            input.value = "";
        }
    </script>
</body>
</html>
