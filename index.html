<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI êµì‚¬ ë³´ì¡° ì‹œìŠ¤í…œ</title>
    <!-- êµ¬ê¸€ ë¡œê·¸ì¸ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- ì•„ì´ì½˜ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #4285f4; --bg: #f4f6f8; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        
        .container { width: 100%; max-width: 600px; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90vh; }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* íƒ­ ë²„íŠ¼ */
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #e0e0e0; border-radius: 8px; font-weight: bold; color: #555; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        /* íƒ­ ë‚´ìš© */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ì…ë ¥ í¼ */
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { resize: vertical; min-height: 100px; font-family: inherit; }
        
        /* ë©”ì¸ ë²„íŠ¼ */
        button.action-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button.action-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* íˆ´ë°” (ë§ˆì´í¬, íŒŒì¼) */
        .toolbar { display: flex; gap: 10px; margin-bottom: 5px; }
        .tool-icon { 
            background: #fff; border: 1px solid #ccc; padding: 8px 12px; 
            border-radius: 20px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;
        }
        .tool-icon:hover { background: #f5f5f5; }
        .tool-icon.recording { color: #d32f2f; border-color: #d32f2f; background: #ffebee; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* ê²°ê³¼ ë°•ìŠ¤ */
        .result-box { background: #f8faff; padding: 15px; border-radius: 8px; margin-top: 15px; white-space: pre-wrap; line-height: 1.6; border-left: 4px solid var(--primary); display: none; }
    </style>
</head>
<body>

    <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen" class="container">
        <div class="card" style="text-align: center; width: 100%;">
            <h2 style="color: var(--primary);">AI êµì‚¬ ë³´ì¡° ì‹œìŠ¤í…œ</h2>
            <p style="color: #666; margin-bottom: 30px;">ì„ ìƒë‹˜ ê³„ì •ìœ¼ë¡œ ì ‘ì†í•´ì£¼ì„¸ìš”.</p>
            
            <!-- êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ (HTML API) -->
            <div id="g_id_onload"
                 data-client_id="1075901830630-jss5b3872vlu0p34t5i8j97gu3puonju.apps.googleusercontent.com" 
                 data-callback="handleCredentialResponse">
            </div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-width="250"></div>
        </div>
    </div>

    <!-- 2. ë©”ì¸ ì•± í™”ë©´ -->
    <div id="app-screen" class="container" style="display: none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0;">Class Assistant</h3>
            <span id="user-name" style="font-size: 14px; color: #666; background: white; padding: 5px 10px; border-radius: 15px;"></span>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab-search')"><i class="fas fa-search"></i> ì¡°íšŒ</button>
            <button class="tab-btn" onclick="switchTab('tab-log')"><i class="fas fa-pen"></i> ê¸°ë¡</button>
            <button class="tab-btn" onclick="switchTab('tab-ai')"><i class="fas fa-robot"></i> AI</button>
        </div>

        <!-- [íƒ­ 1] í•™ìƒ ì¡°íšŒ -->
        <div id="tab-search" class="section active card">
            <h4>ğŸ“‹ í•™ìƒ ì •ë³´ ì¡°íšŒ</h4>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="search-input" placeholder="ì´ë¦„ (ì˜ˆ: ì² ìˆ˜)" onkeydown="if(event.key==='Enter') searchStudent()">
                <button class="action-btn" style="width: 80px; margin-top: 8px;" onclick="searchStudent()">ê²€ìƒ‰</button>
            </div>
            <div id="search-result" class="result-box"></div>
        </div>

        <!-- [íƒ­ 2] ê´€ì°° ê¸°ë¡ -->
        <div id="tab-log" class="section card">
            <h4>ğŸ“ ê´€ì°° ë° ìƒë‹´ ê¸°ë¡</h4>
            <input type="text" id="log-name" placeholder="í•™ìƒ ì´ë¦„">
            <select id="log-category">
                <option value="ìˆ˜ì—…">ìˆ˜ì—… (êµê³¼)</option>
                <option value="ìƒí™œ">ìƒí™œì§€ë„/í–‰ë™</option>
                <option value="ìƒë‹´">ìƒë‹´ (í•™ìƒ/í•™ë¶€ëª¨)</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
            
            <!-- ì…ë ¥ ë„êµ¬ (ìŒì„±/íŒŒì¼) -->
            <div class="toolbar">
                <button class="tool-icon" id="mic-btn" onclick="toggleSpeech()">
                    <i class="fas fa-microphone"></i> ìŒì„± ì…ë ¥
                </button>
                <label class="tool-icon">
                    <i class="fas fa-file-alt"></i> txt íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
                    <input type="file" accept=".txt" style="display: none;" onchange="loadFile(this)">
                </label>
            </div>

            <textarea id="log-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            <button class="action-btn" onclick="saveLog()">ì €ì¥í•˜ê¸°</button>
        </div>

        <!-- [íƒ­ 3] AI ë³´ì¡° -->
        <div id="tab-ai" class="section card" style="border: 2px solid #e8f0fe;">
            <h4 style="color: var(--primary);">ğŸ¤– Gemini ì„ ìƒë‹˜</h4>
            <p style="font-size: 13px; color: #666;">* ëˆ„ì ëœ ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬ ë‹µë³€í•©ë‹ˆë‹¤.</p>
            
            <input type="text" id="ai-name" placeholder="ëŒ€ìƒ í•™ìƒ ì´ë¦„">
            <textarea id="ai-query" placeholder="ì§ˆë¬¸ (ì˜ˆ: ì´ í•™ìƒì˜ êµ­ì–´ ì„¸íŠ¹ ì´ˆì•ˆì„ ì¨ì¤˜)"></textarea>
            <button class="action-btn" onclick="askAI()">AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°</button>
            <div id="ai-result" class="result-box"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // [í•„ìˆ˜ ì„¤ì •] ì—¬ê¸°ì— ê°’ì„ ë„£ì–´ì£¼ì„¸ìš”
        // ==========================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzLrbrW88e-_XeHLksaAUO8wNZt6gfULS5I_inHe17X7ztZKgsUv5iEIVpjFTvViNJITg/exec
"; 
        
        let USER_TOKEN = "";

        // 1. ë¡œê·¸ì¸ ì„±ê³µ ì‹œ í˜¸ì¶œ
        function handleCredentialResponse(response) {
            USER_TOKEN = response.credential;
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("app-screen").style.display = "block";
            document.getElementById("user-name").innerText = `ğŸ‘‹ ${payload.name} ì„ ìƒë‹˜`;
        }

        // 2. íƒ­ ì „í™˜
        function switchTab(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // 3. API í†µì‹  í•¨ìˆ˜
        async function callAPI(action, payload) {
            try {
                const res = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ token: USER_TOKEN, action, ...payload })
                });
                const json = await res.json();
                if (json.status === "error") throw new Error(json.message);
                return json.data;
            } catch (e) {
                alert("ì˜¤ë¥˜: " + e.message);
                return null;
            }
        }

        // [ê¸°ëŠ¥ 1] í•™ìƒ ì¡°íšŒ
        async function searchStudent() {
            const name = document.getElementById("search-input").value.trim();
            if(!name) return;

            const box = document.getElementById("search-result");
            box.style.display = "block";
            box.innerText = "ê²€ìƒ‰ ì¤‘...";
            
            const data = await callAPI("getStudentInfo", { studentName: name });
            
            if (data) {
                box.innerHTML = `
                    <strong>${data.name}</strong> (${data.birth})<br>
                    ğŸ“ ${data.phone}<br>
                    ğŸ  ${data.address}<br>
                    âš ï¸ ${data.memo}<br>
                    ğŸ« ${data.afterSchool}
                `;
            } else {
                box.innerText = "í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        // [ê¸°ëŠ¥ 2] ê¸°ë¡ ì €ì¥
        async function saveLog() {
            const name = document.getElementById("log-name").value.trim();
            const content = document.getElementById("log-content").value.trim();
            if(!name || !content) return alert("ì´ë¦„ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            if(confirm(`${name} í•™ìƒì˜ ê¸°ë¡ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const res = await callAPI("addLog", { 
                    payload: {
                        studentName: name,
                        category: document.getElementById("log-category").value,
                        content: content
                    } 
                });
                if(res) {
                    alert("ì €ì¥ ì™„ë£Œ!");
                    document.getElementById("log-content").value = "";
                }
            }
        }

        // [ê¸°ëŠ¥ 3] AI ì§ˆë¬¸
        async function askAI() {
            const name = document.getElementById("ai-name").value.trim();
            const query = document.getElementById("ai-query").value.trim();
            if(!query) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const box = document.getElementById("ai-result");
            box.style.display = "block";
            box.innerText = "Geminiê°€ ê¸°ë¡ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... â³";
            
            const data = await callAPI("askAI", { studentName: name, query: query });
            if (data) box.innerText = data.answer;
        }

        // [ë„êµ¬ 1] ìŒì„± ì¸ì‹ (STT)
        let recognition = null;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            
            recognition.onstart = () => {
                const btn = document.getElementById("mic-btn");
                btn.classList.add("recording");
                btn.innerHTML = '<i class="fas fa-stop"></i> ë“£ê³  ìˆì–´ìš”...';
            };
            recognition.onend = () => {
                const btn = document.getElementById("mic-btn");
                btn.classList.remove("recording");
                btn.innerHTML = '<i class="fas fa-microphone"></i> ìŒì„± ì…ë ¥';
            };
            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                const area = document.getElementById("log-content");
                area.value += (area.value ? " " : "") + text;
            };
        }

        function toggleSpeech() {
            if (!recognition) return alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (Chrome ê¶Œì¥)");
            const btn = document.getElementById("mic-btn");
            btn.classList.contains("recording") ? recognition.stop() : recognition.start();
        }

        // [ë„êµ¬ 2] íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const area = document.getElementById("log-content");
                area.value += `\n[ì²¨ë¶€: ${file.name}]\n` + e.target.result + "\n";
                alert("íŒŒì¼ ë‚´ìš©ì´ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
            reader.readAsText(file);
            input.value = ""; // ì´ˆê¸°í™”
        }
    </script>
</body>
</html>
