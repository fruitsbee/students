<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Class Assistant</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #4285f4; --bg: #f2f4f7; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); }
        
        /* 레이아웃 */
        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        
        /* 로그인 */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center; }
        
        /* 메인화면 */
        #app-screen { display: none; padding: 15px; padding-bottom: 80px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px 5px; }
        .user-badge { background: #e8f0fe; color: var(--primary); padding: 5px 12px; border-radius: 15px; font-size: 0.9em; font-weight: bold; }

        /* 탭 */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #f1f3f4; padding: 5px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; border-radius: 8px; font-weight: 600; color: #5f6368; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* 섹션 */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* 입력요소 */
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus, textarea:focus { border-color: var(--primary); border-width: 2px; padding: 11px; }
        textarea { resize: none; min-height: 120px; line-height: 1.5; }

        /* 버튼 */
        button.action-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 5px; }
        button.action-btn:active { opacity: 0.8; }

        /* 카드 UI */
        .card { background: white; border-radius: 16px; border: 1px solid #eee; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .card-header { background: linear-gradient(135deg, #4285f4, #1967d2); color: white; padding: 20px; text-align: center; }
        .card-name { font-size: 1.6em; font-weight: 800; margin: 0; }
        .card-sub { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 0.85em; margin-top: 5px; display: inline-block; }
        
        .info-list { padding: 10px 0; }
        .info-item { display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid #f1f3f4; }
        .info-item:last-child { border-bottom: none; }
        .info-icon { width: 32px; height: 32px; background: #e8f0fe; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; }
        .info-text { flex: 1; display: flex; flex-direction: column; }
        .info-label { font-size: 0.75em; color: #5f6368; margin-bottom: 2px; }
        .info-value { font-size: 1em; color: #202124; font-weight: 500; }
        .call-btn { text-decoration: none; background: #e6f4ea; color: #137333; padding: 6px 12px; border-radius: 6px; font-size: 0.8em; font-weight: bold; }
        
        .memo-box { background: #fce8e6; border-left: 4px solid #c5221f; padding: 15px; margin: 0 15px 15px; border-radius: 4px; }
        .memo-title { color: #c5221f; font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px; }
        
        /* 툴바 */
        .toolbar { display: flex; gap: 8px; margin-bottom: 10px; }
        .tool-btn { background: #fff; border: 1px solid #dadce0; padding: 8px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; color: #5f6368; }
        .tool-btn.active { background: #fce8e6; color: #c5221f; border-color: #c5221f; }

        /* 결과박스 */
        .result-box { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-top: 15px; line-height: 1.6; border: 1px solid #dadce0; white-space: pre-wrap; display: none; }
    </style>
</head>
<body>
    <!-- 로그인 화면 -->
    <div id="login-screen">
        <i class="fas fa-school" style="font-size: 3em; color: #4285f4; margin-bottom: 20px;"></i>
        <h2 style="margin-top:0;">Class Assistant</h2>
        <!-- 선생님의 Client ID가 적용된 코드 -->
        <div id="g_id_onload" data-client_id="1075901830630-jss5b3872vlu0p34t5i8j97gu3puonju.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-width="250"></div>
    </div>

    <!-- 앱 화면 -->
    <div id="app-screen" class="app-container">
        <header>
            <h3 style="margin:0;">Class Assistant</h3>
            <span id="user-badge" class="user-badge"></span>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="goTab('search')">학생조회</button>
            <button class="tab-btn" onclick="goTab('log')">기록</button>
            <button class="tab-btn" onclick="goTab('ai')">AI업무</button>
        </div>

        <!-- 1. 조회 탭 -->
        <div id="tab-search" class="section active">
            <div style="display:flex; gap:8px;">
                <input type="text" id="s-input" placeholder="이름 (예: 철수)" onkeydown="if(event.key==='Enter') search()">
                <button class="action-btn" style="width:60px; margin-top:0;" onclick="search()"><i class="fas fa-search"></i></button>
            </div>
            <div id="s-result"></div>
        </div>

        <!-- 2. 기록 탭 -->
        <div id="tab-log" class="section">
            <input type="text" id="l-name" placeholder="학생 이름 (필수 입력)">
            <select id="l-cate">
                <option value="수업">수업</option>
                <option value="생활">생활/행동</option>
                <option value="상담">상담</option>
                <option value="기타">기타</option>
            </select>
            <div class="toolbar">
                <button class="tool-btn" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i> 음성</button>
                <label class="tool-btn"><i class="fas fa-file-upload"></i> 파일 <input type="file" accept=".txt" style="display:none" onchange="loadFile(this)"></label>
            </div>
            <textarea id="l-content" placeholder="내용 입력"></textarea>
            <button class="action-btn" onclick="saveLog()">저장하기</button>
        </div>

        <!-- 3. AI 탭 -->
        <div id="tab-ai" class="section">
            <!-- 개별 질문 -->
            <div class="card" style="padding:15px; box-shadow:none; border:1px solid #ddd;">
                <h4 style="margin:0 0 10px 0;"><i class="fas fa-comment"></i> 개별 상담</h4>
                <input type="text" id="a-name" placeholder="학생 이름">
                <textarea id="a-query" placeholder="질문 내용" style="min-height:80px;"></textarea>
                <button class="action-btn" onclick="askAI()">질문하기</button>
                <div id="a-result" class="result-box"></div>
            </div>

            <!-- 일괄 생성 -->
            <div class="card" style="padding:15px; border:2px solid var(--primary); box-shadow:none;">
                <h4 style="margin:0 0 5px 0; color:var(--primary);"><i class="fas fa-magic"></i> 생기부 일괄 생성</h4>
                <p style="font-size:0.8em; color:#666; margin-bottom:15px;">Guidelines 시트 기반 → Drafts 시트 저장</p>
                <div style="display:flex; gap:10px;">
                    <button class="action-btn" style="background:#137333; margin:0;" onclick="batch('행동특성')">행특 생성</button>
                    <button class="action-btn" style="background:#ea8600; margin:0;" onclick="batchSub()">교과 생성</button>
                </div>
                <!-- 진행바 -->
                <div id="batch-box" style="display:none; margin-top:15px; background:#f8f9fa; padding:10px; border-radius:8px;">
                    <div id="batch-txt" style="font-size:0.9em; font-weight:bold; margin-bottom:5px;">대기중...</div>
                    <div style="background:#dadce0; height:8px; border-radius:4px; overflow:hidden;">
                        <div id="batch-bar" style="width:0%; height:100%; background:var(--primary); transition:width 0.3s;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 선생님의 GAS URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwhPeaw3O2qAPkPEfGUGEc9_Kaqz_T5xULRb3jgzmPq7BNiAtKLl8dnIpoobxHz9wwzUg/exec"; 
        let TOKEN = "";

        // 로그인 콜백 (전역)
        window.handleCredentialResponse = function(res) {
            TOKEN = res.credential;
            try {
                const user = JSON.parse(atob(res.credential.split('.')[1]));
                document.getElementById("login-screen").style.display = "none";
                document.getElementById("app-screen").style.display = "block";
                document.getElementById("user-badge").innerText = user.name + " 선생님";
            } catch (e) {
                alert("로그인 처리 중 오류가 발생했습니다.");
            }
        };

        // UI 함수
        function goTab(id) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        async function api(act, pl) {
            try {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ token: TOKEN, action: act, ...pl }) });
                const json = await res.json();
                if(json.status === "error") throw new Error(json.message);
                return json.data;
            } catch(e) { alert("오류: " + e.message); return null; }
        }

        // 기능 1. 조회
        async function search() {
            const name = document.getElementById("s-input").value.trim();
            if(!name) return;
            document.getElementById("s-input").blur();
            const box = document.getElementById("s-result");
            box.innerHTML = `<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> 조회중...</div>`;
            
            const d = await api("getStudentInfo", { studentName: name });
            if(d) {
                box.innerHTML = `
                <div class="card">
                    <div class="card-header"><h3 class="card-name">${d.name}</h3><span class="card-sub">${d.birth}</span></div>
                    <div class="info-list">
                        <div class="info-item"><div class="info-icon"><i class="fas fa-user-check"></i></div><div class="info-text"><span class="info-label">(주)보호자</span><span class="info-value">${d.parentMain}</span></div><a href="tel:${d.parentMain}" class="call-btn">통화</a></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-user-friends"></i></div><div class="info-text"><span class="info-label">(부)보호자</span><span class="info-value">${d.parentSub||"-"}</span></div></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-school"></i></div><div class="info-text"><span class="info-label">방과후/두레</span><span class="info-value">${d.afterSchool||"-"} | ${d.dure||"-"}</span></div></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-map-marker-alt"></i></div><div class="info-text"><span class="info-label">주소</span><span class="info-value" style="font-size:0.9em">${d.address}</span></div></div>
                    </div>
                    <div class="memo-box"><span class="memo-title">⚠️ 특이사항</span>${d.memo||"없음"}</div>
                </div>`;
            } else { box.innerHTML = `<div style="text-align:center; padding:20px; color:#888;">정보 없음</div>`; }
        }

        // 기능 2. 기록
        async function saveLog() {
            const n = document.getElementById("l-name").value;
            const c = document.getElementById("l-content").value;
            if(!n || !c) return alert("입력해주세요.");
            if(confirm("저장합니까?")) {
                if(await api("addLog", { payload: { studentName: n, category: document.getElementById("l-cate").value, content: c } })) {
                    alert("완료"); document.getElementById("l-content").value = "";
                }
            }
        }

        // 기능 3. AI
        async function askAI() {
            const n = document.getElementById("a-name").value;
            const q = document.getElementById("a-query").value;
            if(!q) return alert("질문하세요.");
            const box = document.getElementById("a-result");
            box.style.display = "block"; box.innerText = "분석중...";
            const d = await api("askAI", { studentName: n, query: q });
            if(d) box.innerText = d.answer;
        }

        function batchSub() { const s = prompt("과목명?"); if(s) batch('교과세특', s); }
        
        async function batch(type, sub="") {
            if(!confirm(`전체 학생 [${type}] 생성?`)) return;
            const box = document.getElementById("batch-box");
            const txt = document.getElementById("batch-txt");
            const bar = document.getElementById("batch-bar");
            box.style.display = "block"; txt.innerText = "명단 로딩중...";
            
            const names = await api("getAllStudentNames", {});
            if(!names) return;
            
            let cnt = 0;
            for(let i=0; i<names.length; i++) {
                const per = Math.round(((i+1)/names.length)*100);
                txt.innerText = `진행중: ${names[i]} (${i+1}/${names.length})`;
                bar.style.width = per + "%";
                try { await api("generateDraft", { studentName: names[i], type: type, subject: sub }); cnt++; } catch(e){}
            }
            txt.innerText = "완료! (Drafts 시트 확인)";
            alert(`총 ${cnt}명 생성 완료.`);
        }

        // 도구 설정
        let rec = window.webkitSpeechRecognition ? new webkitSpeechRecognition() : null;
        if(rec) { 
            rec.lang = 'ko-KR'; 
            rec.onstart = ()=>document.getElementById('btn-mic').classList.add('active'); 
            rec.onend = ()=>document.getElementById('btn-mic').classList.remove('active'); 
            rec.onresult = e => document.getElementById('l-content').value += " " + e.results[0][0].transcript; 
        }
        function toggleMic() { rec ? (document.getElementById('btn-mic').classList.contains('active') ? rec.stop() : rec.start()) : alert("PC 크롬 사용 권장"); }

        // [신규 기능] 파일 업로드 시 자동 마스킹 프리뷰
        function loadFile(input) {
            const file = input.files[0];
            if (!file) return;

            // 1. 학생 이름 체크
            const studentName = document.getElementById("l-name").value.trim();
            if (!studentName) {
                alert("먼저 [학생 이름]을 입력해주세요.\n(누가 대상 학생인지 알아야 마스킹할 수 있습니다)");
                input.value = ""; 
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const rawText = e.target.result;
                const textarea = document.getElementById("l-content");
                
                textarea.value = "⏳ 파일 분석 및 익명화 중...";
                textarea.disabled = true;

                // 2. 프리뷰 요청
                const data = await api("previewMasking", { studentName: studentName, content: rawText });

                if (data) {
                    textarea.value = data.maskedContent;
                    alert("익명화 완료! 내용을 확인하고 [저장]하세요.");
                } else {
                    textarea.value = rawText;
                    alert("마스킹 실패 (원본 입력됨)");
                }
                textarea.disabled = false;
            };
            reader.readAsText(file);
            input.value = "";
        }
    </script>
</body>
</html>
