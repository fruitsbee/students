<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>êµë¬´ ìˆ˜ì²© (Class Assistant)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            /* Warm & Professional Color Palette */
            --bg-color: #F9F9F7;       /* ì¢…ì´ ì§ˆê° ë¯¸ìƒ‰ */
            --sidebar-bg: #2C3E50;     /* ì°¨ë¶„í•œ ë„¤ì´ë¹„ */
            --sidebar-text: #ECF0F1;
            --primary: #34495E;        /* ê¸°ë³¸ í…ìŠ¤íŠ¸/ë²„íŠ¼ */
            --accent: #D35400;         /* í¬ì¸íŠ¸(ë²½ëŒìƒ‰) - ì €ì¥/ì¤‘ìš” */
            --highlight: #F1C40F;      /* í˜•ê´‘íœ ë…¸ë€ìƒ‰ */
            --card-bg: #FFFFFF;
            --border: #E0E0E0;
            --text-main: #2C3E50;
            --text-sub: #7F8C8D;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ì€ ë‚´ë¶€ ì»¨í…Œì´ë„ˆì—ì„œ ì²˜ë¦¬ */
        }

        /* --- [1] ë¡œê·¸ì¸ í™”ë©´ --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center;
            max-width: 320px; width: 90%; border: 1px solid var(--border);
        }

        /* --- [2] ë©”ì¸ ë ˆì´ì•„ì›ƒ (ë°˜ì‘í˜•) --- */
        .app-layout { display: flex; height: 100vh; }

        /* A. ì‚¬ì´ë“œë°” (PC/íƒœë¸”ë¦¿ìš©) */
        .sidebar {
            width: 240px; background: var(--sidebar-bg); color: var(--sidebar-text);
            display: flex; flex-direction: column; padding: 20px;
            flex-shrink: 0;
        }
        .sidebar-brand { font-size: 1.2rem; font-weight: 700; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .sidebar-menu { display: flex; flex-direction: column; gap: 10px; }
        .menu-btn {
            background: transparent; border: none; color: #BDC3C7;
            padding: 12px 15px; text-align: left; font-size: 1rem;
            cursor: pointer; border-radius: 8px; transition: 0.2s;
            display: flex; align-items: center; gap: 12px;
        }
        .menu-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-btn.active { background: var(--accent); color: white; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .user-profile { margin-top: auto; font-size: 0.9rem; color: #BDC3C7; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }

        /* B. ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .page-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; display: none; /* PCì—ì„œë§Œ ë³´ì„ */ }

        /* C. ëª¨ë°”ì¼ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ (ëª¨ë°”ì¼ìš©) */
        .mobile-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid var(--border);
            justify-content: space-around; padding: 10px 0; z-index: 100;
        }
        .nav-item {
            background: none; border: none; color: var(--text-sub);
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.75rem; gap: 4px;
        }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 1.2rem; }

        /* --- [3] 2ë‹¨ ë¶„í•  ë ˆì´ì•„ì›ƒ (Split View) --- */
        .split-view {
            display: grid; grid-template-columns: 1fr; gap: 20px;
            max-width: 1200px; margin: 0 auto;
        }

        /* --- [4] UI ì»´í¬ë„ŒíŠ¸ --- */
        .card {
            background: var(--card-bg); border-radius: 12px;
            padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border);
        }
        
        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 12px;
            border: 1px solid var(--border); border-radius: 8px;
            font-size: 1rem; font-family: inherit;
            box-sizing: border-box; transition: 0.2s;
            background: #FAFAFA;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--accent); outline: none; background: white;
            box-shadow: 0 0 0 3px rgba(211, 84, 0, 0.1);
        }
        textarea { resize: vertical; min-height: 150px; line-height: 1.6; }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        
        /* íˆ´ë°” (íŒŒì¼ì—…ë¡œë“œ, ë§ˆì´í¬) */
        .toolbar { display: flex; gap: 10px; margin-bottom: 10px; }
        .tool-chip {
            background: white; border: 1px solid var(--border);
            padding: 6px 12px; border-radius: 20px; font-size: 0.9rem;
            color: var(--text-sub); cursor: pointer; display: flex; align-items: center; gap: 6px;
        }
        .tool-chip:hover { background: #f0f0f0; }
        .tool-chip.active { background: #FDEDEC; color: var(--accent); border-color: var(--accent); }

        /* ê²°ê³¼ ë°•ìŠ¤ (ì¢…ì´ ëŠë‚Œ) */
        .result-paper {
            background: #fff; border: 1px solid #ddd;
            padding: 20px; border-radius: 4px;
            border-left: 4px solid var(--accent);
            line-height: 1.7; min-height: 100px;
            white-space: pre-wrap;
            /* ë…¸íŠ¸ ì¤„ë¬´ëŠ¬ íš¨ê³¼ */
            background-image: linear-gradient(#eee .1rem, transparent .1rem);
            background-size: 100% 2rem;
            background-position: 0 1.5rem;
        }

        /* ë§ˆìŠ¤í‚¹ í˜•ê´‘íœ íš¨ê³¼ */
        .mask-highlight {
            background: linear-gradient(to top, var(--highlight) 50%, transparent 50%);
            font-weight: bold; padding: 0 2px;
        }

        /* --- [5] ë¯¸ë””ì–´ ì¿¼ë¦¬ (ë°˜ì‘í˜• ì²˜ë¦¬) --- */
        @media (max-width: 768px) {
            .sidebar { display: none; } /* ëª¨ë°”ì¼ì—ì„œ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ */
            .mobile-nav { display: flex; } /* í•˜ë‹¨ë°” í‘œì‹œ */
            .main-content { padding-bottom: 80px; } /* í•˜ë‹¨ë°” ê³µê°„ í™•ë³´ */
            .split-view { grid-template-columns: 1fr; } /* 1ë‹¨ìœ¼ë¡œ ë³€ê²½ */
        }
        @media (min-width: 769px) {
            .page-title { display: block; }
            /* PCì—ì„œëŠ” ì…ë ¥ì°½ê³¼ ê²°ê³¼ì°½ì„ ì¢Œìš°ë¡œ ë°°ì¹˜ */
            .split-view { grid-template-columns: 1fr 1fr; align-items: start; }
            .result-container { position: sticky; top: 20px; } /* ê²°ê³¼ì°½ ìŠ¤í¬ë¡¤ ë”°ë¼ì˜¤ê¸° */
        }

        /* --- [6] ì•Œë¦¼ (Toast & Modal) --- */
        #toast-container {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px;
            border-radius: 30px; font-size: 0.9rem; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 10000;
        }
        #toast-container.show { opacity: 1; bottom: 90px; }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); display: none;
            align-items: center; justify-content: center; z-index: 10;
            border-radius: 12px; font-weight: bold; color: var(--primary);
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <i class="fas fa-book-open" style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"></i>
            <h2 style="margin: 0 0 10px 0; color: var(--primary);">êµë¬´ ìˆ˜ì²©</h2>
            <p style="color: var(--text-sub); margin-bottom: 30px;">ì„ ìƒë‹˜ì„ ìœ„í•œ ìŠ¤ë§ˆíŠ¸í•œ ê¸°ë¡ ë¹„ì„œ</p>
            
            <div id="g_btn_wrapper">
                <div id="g_id_onload" data-client_id="1075901830630-jss5b3872vlu0p34t5i8j97gu3puonju.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-width="280"></div>
            </div>
            <div id="login-loading" style="display:none; font-weight:bold; color:var(--text-sub);">
                <i class="fas fa-circle-notch fa-spin"></i> ì„ ìƒë‹˜ í™•ì¸ ì¤‘...
            </div>
        </div>
    </div>

    <div id="app-screen" class="app-layout" style="display:none;">
        
        <nav class="sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-book-open" style="color: var(--accent);"></i> êµë¬´ ìˆ˜ì²©
            </div>
            <div class="sidebar-menu">
                <button class="menu-btn active" onclick="goTab('search')"><i class="fas fa-search"></i> í•™ìƒ ì¡°íšŒ</button>
                <button class="menu-btn" onclick="goTab('log')"><i class="fas fa-pen-fancy"></i> ê¸°ë¡ í•˜ê¸°</button>
                <button class="menu-btn" onclick="goTab('ai')"><i class="fas fa-robot"></i> AI ì—…ë¬´</button>
            </div>
            <div class="user-profile">
                <i class="fas fa-user-circle"></i> <span id="user-badge">ì„ ìƒë‹˜</span>
            </div>
        </nav>

        <main class="main-content">
            
            <div id="tab-search" class="section active">
                <h2 class="page-title">í•™ìƒ ì¡°íšŒ</h2>
                <div class="split-view">
                    <div class="input-container">
                        <div class="card">
                            <label style="font-weight:bold; display:block; margin-bottom:10px;">ëˆ„êµ¬ë¥¼ ì°¾ìœ¼ì‹œë‚˜ìš”?</label>
                            <div style="display:flex; gap:10px;">
                                <input type="text" id="s-input" placeholder="ì´ë¦„ (ì˜ˆ: í”¼ì¹´ì¸„)" onkeydown="if(event.key==='Enter') search()">
                                <button class="btn btn-primary" style="width:60px;" onclick="search()"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="result-container">
                        <div id="s-result">
                            <div style="text-align:center; color:var(--text-sub); padding:40px;">
                                <i class="fas fa-id-card" style="font-size:3rem; opacity:0.3; margin-bottom:10px;"></i>
                                <p>í•™ìƒ ì´ë¦„ì„ ê²€ìƒ‰í•˜ë©´<br>ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-log" class="section" style="display:none;">
                <h2 class="page-title">ê´€ì°° ê¸°ë¡</h2>
                <div class="split-view">
                    <div class="input-container">
                        <div class="card">
                            <input type="text" id="l-name" placeholder="í•™ìƒ ì´ë¦„ (í•„ìˆ˜)">
                            <select id="l-cate">
                                <option value="ìˆ˜ì—…">ìˆ˜ì—… íƒœë„/ì°¸ì—¬</option>
                                <option value="ìƒí™œ">ìƒí™œ/í–‰ë™ íŠ¹ì„±</option>
                                <option value="ìƒë‹´">ìƒë‹´ ë‚´ìš©</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€ ë©”ëª¨</option>
                            </select>
                            
                            <div class="toolbar">
                                <div class="tool-chip" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i> ìŒì„±</div>
                                <label class="tool-chip"><i class="fas fa-file-upload"></i> íŒŒì¼(TXT) <input type="file" accept=".txt" style="display:none" onchange="loadFile(this)"></label>
                            </div>
                            
                            <div style="position:relative;">
                                <textarea id="l-content" placeholder="ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼ì„ ê¸°ë¡í•˜ì„¸ìš”.&#13;&#10;**ì¤‘ìš”í•œ ì´ë¦„**ì€ ë³„í‘œë¡œ ê°ì‹¸ë©´ ìµëª…í™”ë©ë‹ˆë‹¤."></textarea>
                                <div id="log-loading" class="loading-overlay"><i class="fas fa-spinner fa-spin"></i></div>
                            </div>

                            <button class="btn btn-accent" onclick="saveLog()"><i class="fas fa-save"></i> ê¸°ë¡ ì €ì¥</button>
                        </div>
                    </div>
                    <div class="result-container">
                        <div class="card">
                            <h4 style="margin-top:0; color:var(--text-sub);">ğŸ’¡ ê¸°ë¡ ê°€ì´ë“œ</h4>
                            <ul style="font-size:0.9rem; color:var(--text-sub); padding-left:20px; line-height:1.6;">
                                <li>**ì´ë¦„** ì²˜ëŸ¼ ë³„í‘œë¡œ ê°ì‹¸ë©´ AIì—ê²Œ ë¹„ë°€ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</li>
                                <li>íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ë‚´ìš©ì„ ì±„ì›Œì¤ë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-ai" class="section" style="display:none;">
                <h2 class="page-title">AI ì—…ë¬´ ë³´ì¡°</h2>
                <div class="split-view">
                    <div class="input-container">
                        <div class="card" style="margin-bottom:20px;">
                            <h3 style="font-size:1.1rem; margin-top:0;"><i class="fas fa-comment-dots"></i> AI ìƒë‹´</h3>
                            <input type="text" id="a-name" placeholder="ëŒ€ìƒ í•™ìƒ ì´ë¦„">
                            <textarea id="a-query" placeholder="ì˜ˆ: ì´ í•™ìƒì˜ ì´ë²ˆ í•™ê¸° í–‰ë™ íŠ¹ì„±ì„ ìš”ì•½í•´ì¤˜." style="min-height:100px;"></textarea>
                            <button class="btn btn-primary" onclick="askAI()"><i class="fas fa-paper-plane"></i> ì§ˆë¬¸í•˜ê¸°</button>
                        </div>

                        <div class="card" style="border:1px dashed var(--primary);">
                            <h3 style="font-size:1.1rem; margin-top:0;"><i class="fas fa-magic"></i> ìƒê¸°ë¶€ ì¼ê´„ ìƒì„±</h3>
                            <p style="font-size:0.85rem; color:var(--text-sub);">Guidelines ì‹œíŠ¸ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì´ˆì•ˆì„ ë§Œë“­ë‹ˆë‹¤.</p>
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-accent" style="flex:1; background:#27AE60;" onclick="batch('í–‰ë™íŠ¹ì„±')">í–‰íŠ¹ ìƒì„±</button>
                                <button class="btn btn-accent" style="flex:1; background:#F39C12;" onclick="batchSub()">êµê³¼ ìƒì„±</button>
                            </div>
                            <div id="batch-box" style="display:none; margin-top:15px; background:#f8f9fa; padding:10px; border-radius:8px;">
                                <div id="batch-txt" style="font-size:0.8rem; font-weight:bold; margin-bottom:5px;">ì¤€ë¹„ ì¤‘...</div>
                                <div style="background:#ddd; height:6px; border-radius:3px; overflow:hidden;">
                                    <div id="batch-bar" style="width:0%; height:100%; background:var(--accent); transition:width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="result-container">
                        <div id="a-loading" style="display:none; text-align:center; padding:50px;">
                            <i class="fas fa-robot fa-bounce" style="font-size:2rem; color:var(--primary);"></i>
                            <p>AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                        </div>
                        <div id="a-result-box" style="display:none;">
                            <label style="font-weight:bold; color:var(--accent);">AI ë‹µë³€:</label>
                            <div id="a-result" class="result-paper" style="margin-top:10px;"></div>
                        </div>
                        <div id="a-placeholder" style="text-align:center; color:var(--text-sub); padding:40px;">
                            <i class="fas fa-sparkles" style="font-size:3rem; opacity:0.3; margin-bottom:10px;"></i>
                            <p>ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´<br>ì—¬ê¸°ì— ë‹µë³€ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <nav class="mobile-nav">
            <button class="nav-item active" onclick="goTab('search')">
                <i class="fas fa-search"></i> ì¡°íšŒ
            </button>
            <button class="nav-item" onclick="goTab('log')">
                <i class="fas fa-pen"></i> ê¸°ë¡
            </button>
            <button class="nav-item" onclick="goTab('ai')">
                <i class="fas fa-robot"></i> AI
            </button>
        </nav>
    </div>

    <div id="toast-container">ë©”ì‹œì§€ ë‚´ìš©</div>

    <script>
        // â˜… ë°±ì—”ë“œ ë°°í¬ URL (ì„ ìƒë‹˜ì˜ ìŠ¤í¬ë¦½íŠ¸ URLë¡œ êµì²´ í•„ìš”)
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwhPeaw3O2qAPkPEfGUGEc9_Kaqz_T5xULRb3jgzmPq7BNiAtKLl8dnIpoobxHz9wwzUg/exec"; 
        let TOKEN = "";

        // --- 1. ë¡œê·¸ì¸ ë¡œì§ ---
        window.handleCredentialResponse = async function(res) {
            TOKEN = res.credential;
            document.getElementById("g_btn_wrapper").style.display = "none";
            document.getElementById("login-loading").style.display = "block";

            try {
                // ë°±ì—”ë“œ ê²€ì¦
                const userData = await api("login", {}, true);
                if (userData) {
                    document.getElementById("login-screen").style.display = "none";
                    document.getElementById("app-screen").style.display = "flex"; // flexë¡œ ë³€ê²½
                    document.getElementById("user-badge").innerText = userData.name + " ì„ ìƒë‹˜";
                    showToast(`í™˜ì˜í•©ë‹ˆë‹¤, ${userData.name} ì„ ìƒë‹˜!`);
                } else {
                    throw new Error("ë¡œê·¸ì¸ ì‹¤íŒ¨");
                }
            } catch (e) {
                alert("ğŸš« ì ‘ê·¼ ê¶Œí•œì´ ì—†ëŠ” ê³„ì •ì…ë‹ˆë‹¤.");
                document.getElementById("login-loading").style.display = "none";
                document.getElementById("g_btn_wrapper").style.display = "block";
            }
        };

        // --- 2. API í†µì‹  ---
        async function api(act, pl, isLogin = false) {
            try {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ token: TOKEN, action: act, ...pl }) });
                const json = await res.json();
                if(json.status === "error") {
                    if(isLogin) throw new Error(json.message);
                    alert("ì˜¤ë¥˜: " + json.message); 
                    return null;
                }
                return json.data;
            } catch(e) { 
                if(isLogin) throw e; 
                alert("í†µì‹  ì˜¤ë¥˜: " + e.message); 
                return null; 
            }
        }

        // --- 3. UI ì¸í„°ë™ì…˜ ---
        function goTab(id) {
            // ì„¹ì…˜ ì „í™˜
            document.querySelectorAll('.section').forEach(e => e.style.display = 'none');
            document.getElementById('tab-'+id).style.display = 'block'; // blockìœ¼ë¡œ í‘œì‹œ
            
            // ë²„íŠ¼ í™œì„±í™” (PC ì‚¬ì´ë“œë°” + ëª¨ë°”ì¼ ë„¤ë¹„)
            document.querySelectorAll('.menu-btn, .nav-item').forEach(e => e.classList.remove('active'));
            
            // í˜„ì¬ íƒ­ì— ë§ëŠ” ë²„íŠ¼ë“¤ ì°¾ì•„ì„œ active ì¶”ê°€
            const index = ['search', 'log', 'ai'].indexOf(id);
            document.querySelectorAll('.sidebar-menu .menu-btn')[index].classList.add('active');
            document.querySelectorAll('.mobile-nav .nav-item')[index].classList.add('active');
        }

        function showToast(msg) {
            const el = document.getElementById("toast-container");
            el.innerText = msg;
            el.classList.add("show");
            setTimeout(() => el.classList.remove("show"), 3000);
        }

        function renderMarkdown(text) {
            if (!text) return "";
            // **í…ìŠ¤íŠ¸** -> í˜•ê´‘íœ íš¨ê³¼
            return text.replace(/\*\*(.*?)\*\*/g, '<span class="mask-highlight">$1</span>');
        }

        // --- 4. ê¸°ëŠ¥ë³„ í•¨ìˆ˜ ---

        // [ì¡°íšŒ]
        async function search() {
            const name = document.getElementById("s-input").value.trim();
            if(!name) return showToast("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            const box = document.getElementById("s-result");
            box.innerHTML = `<div style="text-align:center; padding:40px;"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>ìƒí™œê¸°ë¡ë¶€ë¥¼ ì°¾ëŠ” ì¤‘...</div>`;
            
            const d = await api("getStudentInfo", { studentName: name });
            if(d) {
                box.innerHTML = `
                <div class="card" style="border-top: 4px solid var(--accent);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h2 style="margin:0;">${d.name}</h2>
                        <span style="background:#eee; padding:4px 8px; border-radius:4px; font-size:0.9rem;">${d.birth}</span>
                    </div>
                    <div style="display:grid; gap:10px;">
                        <div><strong>ğŸ“ ë³´í˜¸ì:</strong> ${d.parentMain} <a href="tel:${d.parentMain}" style="text-decoration:none;">[ì „í™”]</a></div>
                        <div><strong>ğŸšï¸ ì£¼ì†Œ:</strong> ${d.address}</div>
                        <div><strong>ğŸ« í™œë™:</strong> ${d.afterSchool||"-"} / ${d.dure||"-"}</div>
                    </div>
                    <div style="margin-top:20px; background:#FEF9E7; padding:15px; border-radius:8px;">
                        <strong>âš ï¸ íŠ¹ì´ì‚¬í•­</strong><br>
                        ${d.memo||"íŠ¹ì´ì‚¬í•­ ì—†ìŒ"}
                    </div>
                </div>`;
            } else {
                box.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-sub);">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
        }

        // [ê¸°ë¡]
        async function saveLog() {
            const n = document.getElementById("l-name").value;
            const c = document.getElementById("l-content").value;
            if(!n || !c) return showToast("ì´ë¦„ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            if(confirm(`${n} í•™ìƒì˜ ê¸°ë¡ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                if(await api("addLog", { payload: { studentName: n, category: document.getElementById("l-cate").value, content: c } })) {
                    showToast("ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“");
                    document.getElementById("l-content").value = "";
                }
            }
        }

        function loadFile(input) {
            const file = input.files[0];
            if (!file) return;
            const name = document.getElementById("l-name").value.trim();
            if (!name) {
                input.value = "";
                return alert("ë¨¼ì € í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                document.getElementById("log-loading").style.display = "flex";
                const data = await api("previewMasking", { studentName: name, content: e.target.result });
                document.getElementById("log-loading").style.display = "none";
                
                if (data) {
                    document.getElementById("l-content").value = data.maskedContent;
                    showToast("íŒŒì¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.");
                }
            };
            reader.readAsText(file);
            input.value = "";
        }

        // [AI]
        async function askAI() {
            const n = document.getElementById("a-name").value;
            const q = document.getElementById("a-query").value;
            if(!q) return showToast("ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            // UI ì „í™˜
            document.getElementById("a-placeholder").style.display = "none";
            document.getElementById("a-result-box").style.display = "none";
            document.getElementById("a-loading").style.display = "block";
            
            const d = await api("askAI", { studentName: n, query: q });
            
            document.getElementById("a-loading").style.display = "none";
            if(d) {
                document.getElementById("a-result-box").style.display = "block";
                document.getElementById("a-result").innerHTML = renderMarkdown(d.answer);
            }
        }

        function batchSub() { const s = prompt("ìƒì„±í•  ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: êµ­ì–´)"); if(s) batch('êµê³¼ì„¸íŠ¹', s); }
        
        async function batch(type, sub="") {
            if(!confirm(`ì „ì²´ í•™ìƒì˜ [${type}] ì´ˆì•ˆì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‹œê°„ì´ ë‹¤ì†Œ ì†Œìš”ë©ë‹ˆë‹¤)`)) return;
            
            const box = document.getElementById("batch-box");
            const txt = document.getElementById("batch-txt");
            const bar = document.getElementById("batch-bar");
            box.style.display = "block";
            
            const names = await api("getAllStudentNames", {});
            if(!names) return;
            
            let cnt = 0;
            for(let i=0; i<names.length; i++) {
                const per = Math.round(((i+1)/names.length)*100);
                txt.innerText = `ì‘ì„± ì¤‘: ${names[i]} (${i+1}/${names.length})`;
                bar.style.width = per + "%";
                try { await api("generateDraft", { studentName: names[i], type: type, subject: sub }); cnt++; } catch(e){}
            }
            txt.innerText = "ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (Drafts ì‹œíŠ¸ í™•ì¸)";
            showToast(`ì´ ${cnt}ëª…ì˜ ìƒê¸°ë¶€ ì´ˆì•ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        // ìŒì„± ì¸ì‹
        let rec = window.webkitSpeechRecognition ? new webkitSpeechRecognition() : null;
        if(rec) { 
            rec.lang = 'ko-KR'; 
            rec.onstart = ()=> document.getElementById('btn-mic').classList.add('active'); 
            rec.onend = ()=> document.getElementById('btn-mic').classList.remove('active'); 
            rec.onresult = e => document.getElementById('l-content').value += " " + e.results[0][0].transcript; 
        }
        function toggleMic() { 
            if(!rec) return alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ê¶Œì¥)");
            document.getElementById('btn-mic').classList.contains('active') ? rec.stop() : rec.start(); 
        }

    </script>
</body>
</html>
