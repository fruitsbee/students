<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Class Assistant</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #4285f4; --bg: #f2f4f7; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); }
        
        /* ë ˆì´ì•„ì›ƒ */
        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        
        /* ë¡œê·¸ì¸ */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center; }
        
        /* ë©”ì¸í™”ë©´ */
        #app-screen { display: none; padding: 15px; padding-bottom: 80px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px 5px; }
        .user-badge { background: #e8f0fe; color: var(--primary); padding: 5px 12px; border-radius: 15px; font-size: 0.9em; font-weight: bold; }

        /* íƒ­ */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #f1f3f4; padding: 5px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; border-radius: 8px; font-weight: 600; color: #5f6368; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* ì„¹ì…˜ */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ì…ë ¥ìš”ì†Œ */
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus, textarea:focus { border-color: var(--primary); border-width: 2px; padding: 11px; }
        
        /* [ìˆ˜ì •ë¨] textarea í¬ê¸° ì¡°ì ˆ í•¸ë“¤ í—ˆìš© (ì„¸ë¡œ ë°©í–¥ë§Œ) */
        textarea { 
            resize: vertical; /* vertical: ìƒí•˜ ì¡°ì ˆ ê°€ëŠ¥, none: ì¡°ì ˆ ë¶ˆê°€ */
            min-height: 120px; 
            line-height: 1.5; 
        }

        /* ë²„íŠ¼ */
        button.action-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 5px; }
        button.action-btn:active { opacity: 0.8; }

        /* ì¹´ë“œ UI */
        .card { background: white; border-radius: 16px; border: 1px solid #eee; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .card-header { background: linear-gradient(135deg, #4285f4, #1967d2); color: white; padding: 20px; text-align: center; }
        .card-name { font-size: 1.6em; font-weight: 800; margin: 0; }
        .card-sub { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 0.85em; margin-top: 5px; display: inline-block; }
        
        .info-list { padding: 10px 0; }
        .info-item { display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid #f1f3f4; }
        .info-item:last-child { border-bottom: none; }
        .info-icon { width: 32px; height: 32px; background: #e8f0fe; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; }
        .info-text { flex: 1; display: flex; flex-direction: column; }
        .info-label { font-size: 0.75em; color: #5f6368; margin-bottom: 2px; }
        .info-value { font-size: 1em; color: #202124; font-weight: 500; }
        .call-btn { text-decoration: none; background: #e6f4ea; color: #137333; padding: 6px 12px; border-radius: 6px; font-size: 0.8em; font-weight: bold; }
        
        .memo-box { background: #fce8e6; border-left: 4px solid #c5221f; padding: 15px; margin: 0 15px 15px; border-radius: 4px; }
        .memo-title { color: #c5221f; font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px; }
        
        /* íˆ´ë°” */
        .toolbar { display: flex; gap: 8px; margin-bottom: 10px; }
        .tool-btn { background: #fff; border: 1px solid #dadce0; padding: 8px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; color: #5f6368; }
        .tool-btn.active { background: #fce8e6; color: #c5221f; border-color: #c5221f; }

        /* ê²°ê³¼ë°•ìŠ¤ */
        .result-box { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-top: 15px; line-height: 1.6; border: 1px solid #dadce0; white-space: pre-wrap; display: none; }
        
        /* ë§ˆìŠ¤í‚¹ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .mask-highlight { color: #1a73e8; background-color: #e8f0fe; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì»¨í…Œì´ë„ˆ */
        #login-loading { display: none; margin-top: 20px; color: #5f6368; font-weight: bold; }
    </style>
</head>
<body>
    <div id="login-screen">
        <i class="fas fa-school" style="font-size: 3em; color: #4285f4; margin-bottom: 20px;"></i>
        <h2 style="margin-top:0;">Class Assistant</h2>
        
        <div id="g_btn_wrapper">
            <div id="g_id_onload" data-client_id="1075901830630-jss5b3872vlu0p34t5i8j97gu3puonju.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-width="250"></div>
        </div>

        <div id="login-loading">
            <i class="fas fa-circle-notch fa-spin"></i> ê³„ì • í™•ì¸ ì¤‘...
        </div>
    </div>

    <div id="app-screen" class="app-container">
        <header>
            <h3 style="margin:0;">Class Assistant</h3>
            <span id="user-badge" class="user-badge"></span>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="goTab('search')">í•™ìƒì¡°íšŒ</button>
            <button class="tab-btn" onclick="goTab('log')">ê¸°ë¡</button>
            <button class="tab-btn" onclick="goTab('ai')">AIì—…ë¬´</button>
        </div>

        <div id="tab-search" class="section active">
            <div style="display:flex; gap:8px;">
                <input type="text" id="s-input" placeholder="ì´ë¦„ (ì˜ˆ: ì² ìˆ˜)" onkeydown="if(event.key==='Enter') search()">
                <button class="action-btn" style="width:60px; margin-top:0;" onclick="search()"><i class="fas fa-search"></i></button>
            </div>
            <div id="s-result"></div>
        </div>

        <div id="tab-log" class="section">
            <input type="text" id="l-name" placeholder="í•™ìƒ ì´ë¦„ (í•„ìˆ˜ ì…ë ¥)">
            <select id="l-cate">
                <option value="ìˆ˜ì—…">ìˆ˜ì—…</option>
                <option value="ìƒí™œ">ìƒí™œ/í–‰ë™</option>
                <option value="ìƒë‹´">ìƒë‹´</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
            <div class="toolbar">
                <button class="tool-btn" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i> ìŒì„±</button>
                <label class="tool-btn"><i class="fas fa-file-upload"></i> íŒŒì¼(TXT) <input type="file" accept=".txt" style="display:none" onchange="loadFile(this)"></label>
            </div>
            <p style="font-size:0.8em; color:#666; margin:5px 0;">ğŸ’¡ íŒ: ìµëª…í™”ê°€ í•„ìš”í•œ ë‹¨ì–´ëŠ” **ë³„í‘œ**ë¡œ ê°ì‹¸ì£¼ì„¸ìš”.</p>
            <textarea id="l-content" placeholder="ë‚´ìš© ì…ë ¥"></textarea>
            <button class="action-btn" onclick="saveLog()">ì €ì¥í•˜ê¸°</button>
        </div>

        <div id="tab-ai" class="section">
            <div class="card" style="padding:15px; box-shadow:none; border:1px solid #ddd;">
                <h4 style="margin:0 0 10px 0;"><i class="fas fa-comment"></i> ê°œë³„ ìƒë‹´</h4>
                <input type="text" id="a-name" placeholder="í•™ìƒ ì´ë¦„">
                <textarea id="a-query" placeholder="ì§ˆë¬¸ ë‚´ìš©" style="min-height:80px;"></textarea>
                <button class="action-btn" onclick="askAI()">ì§ˆë¬¸í•˜ê¸°</button>
                <div id="a-result" class="result-box"></div>
            </div>

            <div class="card" style="padding:15px; border:2px solid var(--primary); box-shadow:none;">
                <h4 style="margin:0 0 5px 0; color:var(--primary);"><i class="fas fa-magic"></i> ìƒê¸°ë¶€ ì¼ê´„ ìƒì„±</h4>
                <p style="font-size:0.8em; color:#666; margin-bottom:15px;">Guidelines ì‹œíŠ¸ ê¸°ë°˜ â†’ Drafts ì‹œíŠ¸ ì €ì¥</p>
                <div style="display:flex; gap:10px;">
                    <button class="action-btn" style="background:#137333; margin:0;" onclick="batch('í–‰ë™íŠ¹ì„±')">í–‰íŠ¹ ìƒì„±</button>
                    <button class="action-btn" style="background:#ea8600; margin:0;" onclick="batchSub()">êµê³¼ ìƒì„±</button>
                </div>
                <div id="batch-box" style="display:none; margin-top:15px; background:#f8f9fa; padding:10px; border-radius:8px;">
                    <div id="batch-txt" style="font-size:0.9em; font-weight:bold; margin-bottom:5px;">ëŒ€ê¸°ì¤‘...</div>
                    <div style="background:#dadce0; height:8px; border-radius:4px; overflow:hidden;">
                        <div id="batch-bar" style="width:0%; height:100%; background:var(--primary); transition:width 0.3s;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwhPeaw3O2qAPkPEfGUGEc9_Kaqz_T5xULRb3jgzmPq7BNiAtKLl8dnIpoobxHz9wwzUg/exec"; 
        let TOKEN = "";

        // [ìˆ˜ì •ë¨] ë¡œê·¸ì¸ ê²€ì¦ ë¡œì§ ê°•í™”
        window.handleCredentialResponse = async function(res) {
            TOKEN = res.credential;
            
            // 1. UI ìƒíƒœ ë³€ê²½ (ë¡œë”© ì¤‘ í‘œì‹œ)
            document.getElementById("g_btn_wrapper").style.display = "none";
            document.getElementById("login-loading").style.display = "block";

            try {
                // 2. ë°±ì—”ë“œì— 'login' ì•¡ì…˜ìœ¼ë¡œ ê¶Œí•œ í™•ì¸ ìš”ì²­
                // (ì´ë•Œ ì´ë©”ì¼ì´ ë‹¤ë¥´ë©´ ë°±ì—”ë“œì—ì„œ ì—ëŸ¬ë¥¼ ë˜ì§)
                const userData = await api("login", {}, true); 
                
                if (userData) {
                    // 3. ì„±ê³µ ì‹œ í™”ë©´ ì „í™˜
                    document.getElementById("login-screen").style.display = "none";
                    document.getElementById("app-screen").style.display = "block";
                    document.getElementById("user-badge").innerText = userData.name + " ì„ ìƒë‹˜";
                } else {
                    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì‹¤íŒ¨ë¡œ ê°„ì£¼
                    throw new Error("ë¡œê·¸ì¸ ì‹¤íŒ¨");
                }
            } catch (e) {
                // 4. ì‹¤íŒ¨ ì‹œ ê²½ê³  ë° ë¦¬ì…‹
                alert("ğŸš« ì ‘ê·¼ ê¶Œí•œì´ ì—†ëŠ” ê³„ì •ì…ë‹ˆë‹¤.\n(ë“±ë¡ëœ ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”)");
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì´ˆê¸°í™”
                location.reload();
            }
        };

        // UI í•¨ìˆ˜
        function goTab(id) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        async function api(act, pl, isLogin = false) {
            try {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ token: TOKEN, action: act, ...pl }) });
                const json = await res.json();
                
                if(json.status === "error") {
                    // ë¡œê·¸ì¸ ì‹œë„ ì¤‘ ì—ëŸ¬ëŠ” í˜¸ì¶œí•œ ê³³(handleCredentialResponse)ì—ì„œ catchí•˜ë„ë¡ throw
                    if(isLogin) throw new Error(json.message);
                    
                    // ì¼ë°˜ ì‚¬ìš© ì¤‘ ì—ëŸ¬ëŠ” ì—¬ê¸°ì„œ alert
                    alert("ì˜¤ë¥˜: " + json.message); 
                    return null;
                }
                return json.data;
            } catch(e) { 
                if(isLogin) throw e; 
                alert("í†µì‹  ì˜¤ë¥˜: " + e.message); 
                return null; 
            }
        }

        function renderMarkdown(text) {
            if (!text) return "";
            return text.replace(/\*\*(.*?)\*\*/g, '<span class="mask-highlight">$1</span>');
        }

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ê³¼ ë™ì¼) ---
        async function search() {
            const name = document.getElementById("s-input").value.trim();
            if(!name) return;
            document.getElementById("s-input").blur();
            const box = document.getElementById("s-result");
            box.innerHTML = `<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> ì¡°íšŒì¤‘...</div>`;
            
            const d = await api("getStudentInfo", { studentName: name });
            if(d) {
                box.innerHTML = `
                <div class="card">
                    <div class="card-header"><h3 class="card-name">${d.name}</h3><span class="card-sub">${d.birth}</span></div>
                    <div class="info-list">
                        <div class="info-item"><div class="info-icon"><i class="fas fa-user-check"></i></div><div class="info-text"><span class="info-label">(ì£¼)ë³´í˜¸ì</span><span class="info-value">${d.parentMain}</span></div><a href="tel:${d.parentMain}" class="call-btn">í†µí™”</a></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-user-friends"></i></div><div class="info-text"><span class="info-label">(ë¶€)ë³´í˜¸ì</span><span class="info-value">${d.parentSub||"-"}</span></div></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-school"></i></div><div class="info-text"><span class="info-label">ë°©ê³¼í›„/ë‘ë ˆ</span><span class="info-value">${d.afterSchool||"-"} | ${d.dure||"-"}</span></div></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-map-marker-alt"></i></div><div class="info-text"><span class="info-label">ì£¼ì†Œ</span><span class="info-value" style="font-size:0.9em">${d.address}</span></div></div>
                    </div>
                    <div class="memo-box"><span class="memo-title">âš ï¸ íŠ¹ì´ì‚¬í•­</span>${d.memo||"ì—†ìŒ"}</div>
                </div>`;
            } else { box.innerHTML = `<div style="text-align:center; padding:20px; color:#888;">ì •ë³´ ì—†ìŒ</div>`; }
        }

        async function saveLog() {
            const n = document.getElementById("l-name").value;
            const c = document.getElementById("l-content").value;
            if(!n || !c) return alert("ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if(confirm("ì €ì¥í•©ë‹ˆê¹Œ?")) {
                if(await api("addLog", { payload: { studentName: n, category: document.getElementById("l-cate").value, content: c } })) {
                    alert("ì™„ë£Œ"); document.getElementById("l-content").value = "";
                }
            }
        }

        async function askAI() {
            const n = document.getElementById("a-name").value;
            const q = document.getElementById("a-query").value;
            if(!q) return alert("ì§ˆë¬¸í•˜ì„¸ìš”.");
            const box = document.getElementById("a-result");
            box.style.display = "block"; 
            box.innerText = "ë¶„ì„ì¤‘...";
            
            const d = await api("askAI", { studentName: n, query: q });
            if(d) box.innerHTML = renderMarkdown(d.answer);
        }

        function batchSub() { const s = prompt("ê³¼ëª©ëª…?"); if(s) batch('êµê³¼ì„¸íŠ¹', s); }
        
        async function batch(type, sub="") {
            if(!confirm(`ì „ì²´ í•™ìƒ [${type}] ìƒì„±?`)) return;
            const box = document.getElementById("batch-box");
            const txt = document.getElementById("batch-txt");
            const bar = document.getElementById("batch-bar");
            box.style.display = "block"; txt.innerText = "ëª…ë‹¨ ë¡œë”©ì¤‘...";
            
            const names = await api("getAllStudentNames", {});
            if(!names) return;
            
            let cnt = 0;
            for(let i=0; i<names.length; i++) {
                const per = Math.round(((i+1)/names.length)*100);
                txt.innerText = `ì§„í–‰ì¤‘: ${names[i]} (${i+1}/${names.length})`;
                bar.style.width = per + "%";
                try { await api("generateDraft", { studentName: names[i], type: type, subject: sub }); cnt++; } catch(e){}
            }
            txt.innerText = "ì™„ë£Œ! (Drafts ì‹œíŠ¸ í™•ì¸)";
            alert(`ì´ ${cnt}ëª… ìƒì„± ì™„ë£Œ.`);
        }

        let rec = window.webkitSpeechRecognition ? new webkitSpeechRecognition() : null;
        if(rec) { 
            rec.lang = 'ko-KR'; 
            rec.onstart = ()=>document.getElementById('btn-mic').classList.add('active'); 
            rec.onend = ()=>document.getElementById('btn-mic').classList.remove('active'); 
            rec.onresult = e => document.getElementById('l-content').value += " " + e.results[0][0].transcript; 
        }
        function toggleMic() { rec ? (document.getElementById('btn-mic').classList.contains('active') ? rec.stop() : rec.start()) : alert("PC í¬ë¡¬ ì‚¬ìš© ê¶Œì¥"); }

        function loadFile(input) {
            const file = input.files[0];
            if (!file) return;

            const studentName = document.getElementById("l-name").value.trim();
            if (!studentName) {
                alert("ë¨¼ì € [í•™ìƒ ì´ë¦„]ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ëˆ„ê°€ ëŒ€ìƒ í•™ìƒì¸ì§€ ì•Œì•„ì•¼ ë§ˆìŠ¤í‚¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
                input.value = ""; 
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const rawText = e.target.result;
                const textarea = document.getElementById("l-content");
                
                textarea.value = "â³ íŒŒì¼ ë¶„ì„ ë° ìµëª…í™” ì¤‘...";
                textarea.disabled = true;

                const data = await api("previewMasking", { studentName: studentName, content: rawText });

                if (data) {
                    textarea.value = data.maskedContent;
                    alert("ìµëª…í™” ì™„ë£Œ! ë‚´ìš©ì„ í™•ì¸í•˜ê³  [ì €ì¥]í•˜ì„¸ìš”.\n**ë³„í‘œ**ë¡œ ê°ì‹¸ì§„ ë¶€ë¶„ì€ AIì—ê²Œ ë¹„ë°€ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.");
                } else {
                    textarea.value = rawText;
                    alert("ë§ˆìŠ¤í‚¹ ì‹¤íŒ¨ (ì›ë³¸ ì…ë ¥ë¨)");
                }
                textarea.disabled = false;
            };
            reader.readAsText(file);
            input.value = "";
        }
    </script>
</body>
</html>
