<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI êµì‚¬ ë³´ì¡° ì‹œìŠ¤í…œ (Gemini Pro)</title>
    <!-- êµ¬ê¸€ ë¡œê·¸ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- ì•„ì´ì½˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4285f4; /* êµ¬ê¸€ ë¸”ë£¨ */
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
        }

        /* ë©”ì¸ ì•± í™”ë©´ ìŠ¤íƒ€ì¼ */
        #app-screen {
            display: none; /* ë¡œê·¸ì¸ ì „ ìˆ¨ê¹€ */
            width: 100%;
            max-width: 600px;
            padding: 20px;
            box-sizing: border-box;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-profile {
            font-size: 0.9em;
            color: #666;
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tabs {
            display: flex;
            background: #e0e0e0;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 10px;
            font-weight: bold;
            color: #666;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* ì»¨í…ì¸  ì„¹ì…˜ */
        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            animation: fadeIn 0.3s ease;
        }
        
        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.9em; color: #555; }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
        }
        
        textarea { resize: vertical; min-height: 100px; }

        button.action-btn {
            width: 100%;
            margin-top: 20px;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button.action-btn:active { background-color: #3367d6; }
        button.action-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* ê²°ê³¼ ë°•ìŠ¤ */
        .result-box {
            margin-top: 20px;
            padding: 15px;
            background: #f8faff;
            border-left: 4px solid var(--primary-color);
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .error-msg { color: #d32f2f; background: #ffebee; border-left-color: #d32f2f; }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
            display: none;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen">
        <div class="login-card">
            <h2>AI êµì‚¬ ë³´ì¡° ì‹œìŠ¤í…œ</h2>
            <p style="color:#666; margin-bottom:30px;">ì„ ìƒë‹˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            
            <!-- êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ -->
            <div id="g_id_onload"
                 data-client_id="1075901830630-jss5b3872vlu0p34t5i8j97gu3puonju.apps.googleusercontent.com" 
                 data-callback="handleCredentialResponse">
            </div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_blue" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
        </div>
    </div>

    <!-- 2. ë©”ì¸ ì•± í™”ë©´ -->
    <div id="app-screen">
        <header>
            <h2 style="margin:0;">Class Assistant</h2>
            <div class="user-profile" id="user-info"></div>
        </header>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('tab-search')"><i class="fas fa-search"></i> í•™ìƒ ì¡°íšŒ</button>
            <button class="tab-btn" onclick="showTab('tab-log')"><i class="fas fa-pen"></i> ê¸°ë¡</button>
            <button class="tab-btn" onclick="showTab('tab-ai')"><i class="fas fa-robot"></i> AI ë³´ì¡°</button>
        </div>

        <!-- íƒ­ 1: í•™ìƒ ì¡°íšŒ -->
        <div id="tab-search" class="section active">
            <h3>ğŸ“‹ í•™ìƒ ê¸°ì´ˆ ì •ë³´</h3>
            <label>í•™ìƒ ì´ë¦„</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="search-name" placeholder="ì´ë¦„ ì…ë ¥ (ì˜ˆ: ê¹€ì² ìˆ˜)" onkeydown="if(event.key==='Enter') searchStudent()">
                <button class="action-btn" style="width:auto; margin-top:5px;" onclick="searchStudent()">ê²€ìƒ‰</button>
            </div>
            <div id="search-result" class="result-box" style="display:none;"></div>
        </div>

        <!-- íƒ­ 2: ê¸°ë¡ ë‚¨ê¸°ê¸° -->
        <div id="tab-log" class="section">
            <h3>ğŸ“ ê´€ì°° ë° ìƒë‹´ ê¸°ë¡</h3>
            
            <label>í•™ìƒ ì´ë¦„</label>
            <input type="text" id="log-name" placeholder="ì´ë¦„ ì…ë ¥">
            
            <label>ì˜ì—­ (ì¹´í…Œê³ ë¦¬)</label>
            <select id="log-category">
                <option value="ìˆ˜ì—…(êµ­ì–´)">ìˆ˜ì—… (êµ­ì–´)</option>
                <option value="ìˆ˜ì—…(ìˆ˜í•™)">ìˆ˜ì—… (ìˆ˜í•™)</option>
                <option value="ìˆ˜ì—…(ì‚¬íšŒ)">ìˆ˜ì—… (ì‚¬íšŒ)</option>
                <option value="ìˆ˜ì—…(ê³¼í•™)">ìˆ˜ì—… (ê³¼í•™)</option>
                <option value="ìˆ˜ì—…(ê¸°íƒ€)">ìˆ˜ì—… (ê¸°íƒ€)</option>
                <option value="ìƒí™œ/í–‰ë™">ìƒí™œì§€ë„/í–‰ë™ë°œë‹¬</option>
                <option value="ìƒë‹´">í•™ìƒ/í•™ë¶€ëª¨ ìƒë‹´</option>
                <option value="ì°½ì²´/ì§„ë¡œ">ì°½ì²´/ì§„ë¡œ/ë™ì•„ë¦¬</option>
            </select>
            
            <label>ë‚´ìš© (íŠ¹ì´ì‚¬í•­, ê´€ì°°ë‚´ìš©)</label>
            <textarea id="log-content" placeholder="ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼ì„ ìƒì„¸íˆ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
            
            <button id="btn-save-log" class="action-btn" onclick="saveLog()">
                <div class="spinner"></div> ì €ì¥í•˜ê¸°
            </button>
        </div>

        <!-- íƒ­ 3: AI ë³´ì¡° (Gemini) -->
        <div id="tab-ai" class="section" style="border: 2px solid #e8f0fe;">
            <h3 style="color:#4285f4;">ğŸ¤– Gemini ë³´ì¡°êµì‚¬</h3>
            <p style="font-size:0.9em; color:#666; margin-top:-10px;">ëˆ„ì ëœ í•™ìƒ ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬ ë‹µë³€í•©ë‹ˆë‹¤.</p>
            
            <label>ëŒ€ìƒ í•™ìƒ</label>
            <input type="text" id="ai-name" placeholder="ì´ë¦„ (ë¹„ì›Œë‘ë©´ ì¼ë°˜ êµìœ¡ ì§ˆë¬¸)">
            
            <label>ìš”ì²­ ì‚¬í•­</label>
            <textarea id="ai-query" placeholder="ì˜ˆ: ì´ í•™ìƒì˜ ì´ë²ˆ í•™ê¸° ìˆ˜í•™ í•™ìŠµ ë°œë‹¬ ìƒí™©ì„ ìƒê¸°ë¶€ ìŠ¤íƒ€ì¼ë¡œ ìš”ì•½í•´ì¤˜."></textarea>
            
            <button id="btn-ask-ai" class="action-btn" onclick="askAI()" style="background-color:#4285f4;">
                <div class="spinner"></div> AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°
            </button>
            
            <div id="ai-result" class="result-box" style="display:none; background-color: #f1f8ff; border-color: #4285f4;"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // [ì„¤ì •] ì•„ë˜ ë‘ ë³€ìˆ˜ë¥¼ ë°˜ë“œì‹œ ìˆ˜ì •í•˜ì„¸ìš”!
        // ==========================================
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzLrbrW88e-_XeHLksaAUO8wNZt6gfULS5I_inHe17X7ztZKgsUv5iEIVpjFTvViNJITg/exec";
        
        // ==========================================
        // [ì „ì—­ ë³€ìˆ˜]
        // ==========================================
        let USER_TOKEN = ""; // ë¡œê·¸ì¸ ì‹œ ë°œê¸‰ë°›ëŠ” ë³´ì•ˆ í† í°

        // 1. êµ¬ê¸€ ë¡œê·¸ì¸ ì½œë°±
        function handleCredentialResponse(response) {
            USER_TOKEN = response.credential;
            
            // í† í° ë””ì½”ë”©í•˜ì—¬ ì‚¬ìš©ì ì´ë¦„ ì¶”ì¶œ (UI í‘œì‹œìš©)
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("app-screen").style.display = "block";
            document.getElementById("user-info").innerHTML = `<i class="fas fa-user-circle"></i> ${payload.name} ì„ ìƒë‹˜`;
        }

        // 2. íƒ­ ì „í™˜ ê¸°ëŠ¥
        function showTab(tabId) {
            // ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // 3. API í†µì‹  ê³µí†µ í•¨ìˆ˜ (GAS ë°±ì—”ë“œë¡œ ì „ì†¡)
        async function sendToGAS(action, payload = {}, btnId = null) {
            const btn = btnId ? document.getElementById(btnId) : null;
            const originalText = btn ? btn.innerText : "";
            const spinner = btn ? btn.querySelector('.spinner') : null;

            if (btn) {
                btn.disabled = true;
                if(spinner) spinner.style.display = "inline-block";
            }

            try {
                // POST ìš”ì²­ ë³´ë‚´ê¸°
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        token: USER_TOKEN, // ë³´ì•ˆ í‚¤ ë™ë´‰
                        action: action,
                        ...payload
                    })
                });
                
                const json = await response.json();
                
                if (json.status === "error") {
                    throw new Error(json.message);
                }
                
                return json.data;

            } catch (error) {
                alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
                return null;
            } finally {
                if (btn) {
                    btn.disabled = false;
                    if(spinner) spinner.style.display = "none";
                }
            }
        }

        // 4. [ê¸°ëŠ¥] í•™ìƒ ì¡°íšŒ
        async function searchStudent() {
            const name = document.getElementById("search-name").value.trim();
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const resultBox = document.getElementById("search-result");
            resultBox.style.display = "block";
            resultBox.innerText = "ê²€ìƒ‰ ì¤‘...";
            
            const data = await sendToGAS("getStudentInfo", { studentName: name });
            
            if (data) {
                resultBox.innerHTML = `
                <strong>ì´ë¦„:</strong> ${data.name}<br>
                <strong>ìƒë…„ì›”ì¼:</strong> ${data.birth}<br>
                <strong>ì—°ë½ì²˜:</strong> ${data.phone}<br>
                <strong>ì£¼ì†Œ:</strong> ${data.address}<br>
                <strong>ë°©ê³¼í›„:</strong> ${data.afterSchool}<br><br>
                <strong style='color:red;'>âš ï¸ íŠ¹ì´ì‚¬í•­:</strong> ${data.memo}
                `;
            } else {
                resultBox.innerText = "í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        // 5. [ê¸°ëŠ¥] ë¡œê·¸ ì €ì¥
        async function saveLog() {
            const name = document.getElementById("log-name").value.trim();
            const content = document.getElementById("log-content").value.trim();
            
            if(!name || !content) return alert("ì´ë¦„ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");

            const payload = {
                studentName: name,
                category: document.getElementById("log-category").value,
                content: content
            };

            const data = await sendToGAS("addLog", { payload: payload }, "btn-save-log");
            
            if (data) {
                alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById("log-content").value = ""; // ë‚´ìš© ì´ˆê¸°í™”
            }
        }

        // 6. [ê¸°ëŠ¥] AI ì§ˆë¬¸ (RAG)
        async function askAI() {
            const query = document.getElementById("ai-query").value.trim();
            const name = document.getElementById("ai-name").value.trim();
            
            if(!query) return alert("ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const resultBox = document.getElementById("ai-result");
            resultBox.style.display = "block";
            resultBox.innerText = "Geminiê°€ í•™ìƒ ê¸°ë¡ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤... (ì•½ 5~10ì´ˆ ì†Œìš”)";
            
            const data = await sendToGAS("askAI", { 
                studentName: name, 
                query: query 
            }, "btn-ask-ai");
            
            if (data) {
                // ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ í…ìŠ¤íŠ¸ë¥¼ ì¤„ë°”ê¿ˆ ì²˜ë¦¬í•˜ì—¬ í‘œì‹œ
                resultBox.innerText = data.answer;
            }
        }
    </script>
</body>
</html>
